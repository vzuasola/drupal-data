variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - tests
  - package
  - deploy-dev
  - integration-tests-development
  - deploy-test
  - deploy-staging
  - staging-signoff
  - deploy-internal-production
  - internal-production-signoff
  - deploy-production

before_script:
  - export VERSION=$(echo $CI_COMMIT_REF_NAME | sed -E "s/release-v?//g")

create package:
  stage: package
  script:
      - python -u automation/run.py --stage package
  only:
    - /^(working|CI|release-.*)$/
  cache:
    paths:
      - vendor/
  artifacts:
      paths:
        - "*.tar.gz"
      expire_in: 1 day

static code analysis:
  stage: tests
  script:
      - python -u automation/run.py --stage sonarqube
  only:
    - /^(working|CI|release-.*)$/

dev:
  stage: deploy-dev
  environment:
    name: development
    url: https://FIXME.NOW
  script:
      - python -u automation/run.py --stage deploy-development
  when: manual
  artifacts:
      paths:
        - automation/deployed/*.jsonl

integration-tests-development:
  stage: integration-tests-development
  script:
      - python -u automation/run.py --stage integration-tests-development
  when: manual
  artifacts:
      paths:
        - automation/deployed/*.jsonl

qa:
  stage: deploy-test
  environment:
    name: testing
    url: https://FIXME.NOW
  script:
      - python -u automation/run.py --stage deploy-testing
  when: manual
  dependencies:
   - dev
  artifacts:
      paths:
        - automation/deployed/*.jsonl

tct:
  stage: deploy-test
  environment:
    name: tct
    url: https://FIXME.NOW
  script:
      - python -u automation/run.py --stage deploy-tct
  when: manual
  dependencies:
   - dev
  artifacts:
      paths:
        - automation/deployed/*.jsonl

staging:
  stage: deploy-staging
  environment:
    name: staging
    url: https://FIXME.NOW
  script:
      - python -u automation/run.py --stage deploy-uat
  when: manual
  dependencies:
   - qa
  artifacts:
      paths:
        - automation/deployed/*.jsonl

uat:
  stage: deploy-staging
  environment:
    name: uat
    url: https://FIXME.NOW
  script:
      - python -u automation/run.py --stage deploy-staging
  when: manual
  dependencies:
   - qa
  artifacts:
      paths:
        - automation/deployed/*.jsonl

staging-signoff:
  stage: staging-signoff
  environment:
    name: staging-signoff
  script:
      - python -u automation/run.py --stage staging-signoff
  when: manual
  dependencies:
   - staging
  artifacts:
      paths:
        - automation/deployed/*.jsonl

internal prod:
  stage: deploy-internal-production
  environment:
    name: internal-production
    url: https://FIXME.NOW
  script:
      - python -u automation/run.py --stage deploy-internal-production
  when: manual
  dependencies:
   - staging-signoff
  artifacts:
      paths:
        - automation/deployed/*.jsonl

production:
  stage: deploy-production
  environment:
    name: production
    url: https://FIXME.NOW
  script:
      - python -u automation/run.py --stage deploy-production
  when: manual
  artifacts:
      paths:
        - automation/deployed/*.jsonl
