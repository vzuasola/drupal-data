parameters:
  workspace.default: live
  workspace.factory.keyvalue.sorted_set:
    default: keyvalue.sorted_set.database

services:
  workspace.paramconverter.entity_revision:
    class: Drupal\workspace\ParamConverter\EntityRevisionConverter
    arguments: ['@entity.manager']
    tags:
      - { name: paramconverter, priority: 30 }
  access_check.workspace_view:
    class: Drupal\workspace\Access\WorkspaceViewCheck
    tags:
      - { name: access_check, applies_to: _workspace_view }
  workspace.manager:
    class: Drupal\workspace\WorkspaceManager
    arguments: ['@request_stack', '@entity_type.manager', '@current_user', '@logger.channel.workspace']
    tags:
      - { name: service_collector, tag: workspace_negotiator, call: addNegotiator }
  workspace.index.sequence:
    class: Drupal\workspace\Index\SequenceIndex
    arguments: ['@workspace.keyvalue.sorted_set', '@workspace.manager']
  workspace.changes_factory:
    class: Drupal\workspace\Changes\ChangesFactory
    arguments: ['@entity_type.manager', '@workspace.index.sequence']
  workspace.keyvalue.sorted_set:
    class: Drupal\workspace\KeyValueStore\KeyValueSortedSetFactory
    arguments: ['@service_container', '%workspace.factory.keyvalue.sorted_set%']
  workspace.keyvalue.sorted_set.database:
    class: Drupal\workspace\KeyValueStore\KeyValueDatabaseSortedSetFactory
    arguments: ['@serialization.phpserialize', '@database']
  workspace.upstream_manager:
    class: Drupal\workspace\UpstreamManager
    parent: default_plugin_manager

  workspace.replication_manager:
    class: Drupal\workspace\Replication\ReplicationManager
    tags:
      - { name: service_collector, tag: workspace_replicator, call: addReplicator }
  workspace.default_replicator:
    class: Drupal\workspace\Replication\DefaultReplicator
    arguments: ['@workspace.manager', '@workspace.changes_factory', '@entity_type.manager', '@workspace.index.sequence']
    tags:
      - { name: workspace_replicator, priority: 0 }

  workspace.negotiator.default:
    class: Drupal\workspace\Negotiator\DefaultWorkspaceNegotiator
    calls:
      - [setContainer, ['@service_container']]
      - [setCurrentUser, ['@current_user']]
      - [setWorkspaceManager, ['@workspace.manager']]
    tags:
      - { name: workspace_negotiator, priority: 0 }
  workspace.negotiator.session:
    class: Drupal\workspace\Negotiator\SessionWorkspaceNegotiator
    arguments: ['@user.private_tempstore']
    calls:
      - [setContainer, ['@service_container']]
      - [setCurrentUser, ['@current_user']]
      - [setWorkspaceManager, ['@workspace.manager']]
    tags:
      - { name: workspace_negotiator, priority: 100 }
  workspace.negotiator.param:
    class: Drupal\workspace\Negotiator\ParamWorkspaceNegotiator
    calls:
      - [setContainer, ['@service_container']]
      - [setCurrentUser, ['@current_user']]
      - [setWorkspaceManager, ['@workspace.manager']]
    tags:
      - { name: workspace_negotiator, priority: 200 }

  cache_context.workspace:
    class: Drupal\workspace\WorkspaceCacheContext
    arguments: ['@workspace.manager']
    tags:
      - { name: cache.context }
  logger.channel.workspace:
    parent: logger.channel_base
    arguments: ['cron']
